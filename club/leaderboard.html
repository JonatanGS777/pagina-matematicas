<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla de Posiciones en Vivo - Competencias Matem√°ticas</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #5B4CF5;
            --secondary: #3D1F8C;
            --accent: #00E5C3;
            --success: #00D4AA;
            --warning: #F5C842;
            --danger: #FF4D6D;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
            --dark: #0D0E1A;
            --light: #F0EEF8;
            --white: #ffffff;
            --text-primary: #1A1B2E;
            --text-secondary: #5C5F78;
            --glass: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --shadow-soft: 0 8px 40px 0 rgba(91, 76, 245, 0.28);
            --shadow-hover: 0 20px 50px rgba(91, 76, 245, 0.32);
            --gradient-main: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --gradient-gold: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            --gradient-silver: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            --gradient-bronze: linear-gradient(135deg, #cd7f32 0%, #daa520 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Syne', sans-serif;
            background: linear-gradient(135deg, #5B4CF5 0%, #3D1F8C 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            padding-top: 80px;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                linear-gradient(-45deg, rgba(91, 76, 245, 0.88), rgba(61, 31, 140, 0.92), rgba(0, 229, 195, 0.55), rgba(91, 76, 245, 0.82));
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(240, 238, 248, 0.92);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border-bottom: 1px solid rgba(91, 76, 245, 0.1);
            box-shadow: 0 1px 0 rgba(91, 76, 245, 0.06), 0 4px 24px rgba(13, 14, 26, 0.06);
            z-index: 1000;
            padding: 0;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
        }

        .logo {
            font-family: 'Syne', sans-serif;
            font-size: 1.45rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
            transition: opacity 0.2s ease;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-back {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background: var(--gradient-main);
            color: var(--white);
            text-decoration: none;
            border-radius: 12px;
            font-family: 'Syne', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-back:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(91, 76, 245, 0.4);
        }

        .refresh-btn {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background: var(--success);
            color: var(--white);
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(78, 205, 196, 0.3);
        }

        /* Live Status */
        .live-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--danger);
            color: var(--white);
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--white);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Main Content */
        .main-content {
            background: var(--light);
            border-radius: 50px 50px 0 0;
            margin-top: 0;
            position: relative;
            z-index: 10;
            min-height: 100vh;
            padding-top: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Hero Stats */
        .hero-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: 25px;
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-main);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-number {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Leaderboard Container */
        .leaderboard-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        /* Main Leaderboard */
        .leaderboard-main {
            background: var(--white);
            border-radius: 25px;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .leaderboard-header {
            background: var(--gradient-main);
            color: var(--white);
            padding: 2rem;
            text-align: center;
        }

        .leaderboard-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .leaderboard-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: end;
            padding: 2rem;
            gap: 1rem;
        }

        .podium-place {
            text-align: center;
            transition: all 0.3s ease;
        }

        .podium-place:hover {
            transform: translateY(-10px);
        }

        .podium-place.first {
            order: 2;
        }

        .podium-place.second {
            order: 1;
        }

        .podium-place.third {
            order: 3;
        }

        .podium-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--white);
            font-weight: 700;
            position: relative;
        }

        .podium-place.first .podium-avatar {
            background: var(--gradient-gold);
            width: 100px;
            height: 100px;
            font-size: 2.5rem;
        }

        .podium-place.second .podium-avatar {
            background: var(--gradient-silver);
            color: var(--dark);
        }

        .podium-place.third .podium-avatar {
            background: var(--gradient-bronze);
        }

        .podium-crown {
            position: absolute;
            top: -10px;
            font-size: 1.5rem;
            color: var(--gold);
        }

        .podium-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .podium-school {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .podium-score {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
        }

        /* Detailed Rankings */
        .rankings-table {
            padding: 0;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .ranking-item:hover {
            background: var(--light);
            transform: translateX(10px);
        }

        .ranking-item.highlight {
            background: linear-gradient(135deg, rgba(91, 76, 245, 0.1), rgba(240, 147, 251, 0.1));
            border-left: 4px solid var(--primary);
        }

        .rank-position {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-right: 2rem;
            min-width: 50px;
            text-align: center;
        }

        .rank-change {
            margin-left: 0.5rem;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .rank-change.up {
            background: rgba(78, 205, 196, 0.2);
            color: var(--success);
        }

        .rank-change.down {
            background: rgba(255, 107, 107, 0.2);
            color: var(--danger);
        }

        .rank-change.same {
            background: rgba(113, 128, 150, 0.2);
            color: var(--text-secondary);
        }

        .participant-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-main);
            color: var(--white);
            font-weight: 600;
        }

        .participant-details {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .participant-info {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .participant-score-section {
            text-align: right;
            min-width: 120px;
        }

        .participant-total-score {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .score-breakdown {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .area-score {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-weight: 500;
        }

        .area-score.algebra { background: rgba(255, 107, 107, 0.2); color: #e53e3e; }
        .area-score.geometry { background: rgba(78, 205, 196, 0.2); color: #319795; }
        .area-score.calculus { background: rgba(91, 76, 245, 0.2); color: #5a67d8; }
        .area-score.trigonometry { background: rgba(240, 147, 251, 0.2); color: #d53f8c; }
        .area-score.mental-calc { background: rgba(168, 85, 247, 0.2); color: #805ad5; }
        .area-score.puzzles { background: rgba(245, 158, 11, 0.2); color: #d69e2e; }

        /* Sidebar */
        .leaderboard-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-card {
            background: var(--white);
            border-radius: 25px;
            padding: 2rem;
            box-shadow: var(--shadow-soft);
        }

        .sidebar-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Area Performance */
        .area-performance {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .area-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--light);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .area-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .area-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .area-icon-small {
            font-size: 1.5rem;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .area-stats-right {
            text-align: right;
        }

        .area-average {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            color: var(--primary);
        }

        .area-participants {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Recent Activity */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            transform: translateX(5px);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--success);
            color: var(--white);
            font-size: 1rem;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Records */
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--light);
            border-radius: 15px;
            margin-bottom: 1rem;
        }

        .record-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .record-value {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            color: var(--success);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .leaderboard-container {
                grid-template-columns: 1fr;
            }
            
            .podium {
                flex-direction: column;
                align-items: center;
            }
            
            .podium-place {
                margin-bottom: 2rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 2rem 1rem;
            }
            
            .ranking-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1.5rem 1rem;
            }
            
            .participant-info {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .hero-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .navbar {
                padding: 1rem;
            }
        }

        /* Animation for position changes */
        .position-change {
            animation: positionHighlight 2s ease-in-out;
        }

        @keyframes positionHighlight {
            0%, 100% { background: transparent; }
            50% { background: linear-gradient(135deg, rgba(78, 205, 196, 0.3), rgba(91, 76, 245, 0.35)); }
        }

        /* New record alert */
        .new-record {
            animation: recordGlow 3s ease-in-out;
        }

        @keyframes recordGlow {
            0%, 100% { box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); }
            50% { box-shadow: 0 8px 32px 0 rgba(255, 215, 0, 0.6); }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Waiting timer animation */
        @keyframes waitingPulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.05);
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg"></div>

    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <a href="#" class="logo">
                <i class="fas fa-trophy"></i>
                Tabla de Posiciones en Vivo
            </a>
            
            <div class="nav-controls">
                <div class="live-status">
                    <div class="live-dot"></div>
                    EN VIVO
                </div>
                
                <button class="refresh-btn" onclick="refreshLeaderboard()">
                    <i class="fas fa-sync-alt"></i>
                    <span class="loading" id="refreshLoading" style="display: none;"></span>
                    <span id="refreshText">Actualizar</span>
                </button>

                <button class="refresh-btn" onclick="startCompetitionTimer()" style="background: var(--primary); margin-left: 0.5rem;">
                    <i class="fas fa-play"></i>
                    Iniciar Timer
                </button>

                <button class="refresh-btn" onclick="resetCompetition()" style="background: var(--text-secondary); margin-left: 0.5rem; font-size: 0.8rem; opacity: 0.7;">
                    <i class="fas fa-cog"></i>
                    Admin
                </button>
                
                <a href="competencias.html" class="nav-back">
                    <i class="fas fa-arrow-left"></i>
                    Volver a Competencias
                </a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Hero Stats -->
            <div class="hero-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number" id="totalParticipants">0</div>
                    <div class="stat-label">Participantes Activos</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number" id="timeRemaining">01:45:23</div>
                    <div class="stat-label">Tiempo Restante</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-number" id="averageScore">0</div>
                    <div class="stat-label">Puntuaci√≥n Promedio</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="stat-number" id="topScore">0</div>
                    <div class="stat-label">Puntuaci√≥n M√°xima</div>
                </div>
            </div>

            <!-- Leaderboard Container -->
            <div class="leaderboard-container">
                <!-- Main Leaderboard -->
                <div class="leaderboard-main">
                    <div class="leaderboard-header">
                        <h2 class="leaderboard-title">
                            <i class="fas fa-crown"></i>
                            Tabla de Posiciones
                        </h2>
                        <p class="leaderboard-subtitle">Actualizaci√≥n autom√°tica cada 10 segundos</p>
                    </div>

                    <!-- Podium -->
                    <div class="podium">
                        <div class="podium-place second">
                            <div class="podium-avatar" id="podium2Avatar">2</div>
                            <div class="podium-name" id="podium2Name">-</div>
                            <div class="podium-school" id="podium2School">-</div>
                            <div class="podium-score" id="podium2Score">0 pts</div>
                        </div>

                        <div class="podium-place first">
                            <div class="podium-avatar" id="podium1Avatar">
                                <div class="podium-crown">üëë</div>
                                1
                            </div>
                            <div class="podium-name" id="podium1Name">-</div>
                            <div class="podium-school" id="podium1School">-</div>
                            <div class="podium-score" id="podium1Score">0 pts</div>
                        </div>

                        <div class="podium-place third">
                            <div class="podium-avatar" id="podium3Avatar">3</div>
                            <div class="podium-name" id="podium3Name">-</div>
                            <div class="podium-school" id="podium3School">-</div>
                            <div class="podium-score" id="podium3Score">0 pts</div>
                        </div>
                    </div>

                    <!-- Detailed Rankings -->
                    <div class="rankings-table" id="rankingsTable">
                        <!-- Rankings will be populated here -->
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="leaderboard-sidebar">
                    <!-- Area Performance -->
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">
                            <i class="fas fa-chart-bar"></i>
                            Rendimiento por √Årea
                        </h3>
                        <div class="area-performance" id="areaPerformance">
                            <!-- Area stats will be populated here -->
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">
                            <i class="fas fa-bolt"></i>
                            Actividad Reciente
                        </h3>
                        <div class="activity-list" id="activityList">
                            <!-- Recent activity will be populated here -->
                        </div>
                    </div>

                    <!-- Records -->
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">
                            <i class="fas fa-medal"></i>
                            R√©cords de Hoy
                        </h3>
                        <div class="record-item">
                            <span class="record-label">Mejor Tiempo</span>
                            <span class="record-value" id="bestTime">--:--</span>
                        </div>
                        <div class="record-item">
                            <span class="record-label">Racha M√°xima</span>
                            <span class="record-value" id="bestStreak">0</span>
                        </div>
                        <div class="record-item">
                            <span class="record-label">M√°s Activo</span>
                            <span class="record-value" id="mostActive">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Live Leaderboard ‚Äî Supabase Real-Time
        class LiveLeaderboard {
            constructor() {
                this.SUPABASE_URL     = 'https://mywwtkpcswisdwrfqzch.supabase.co';
                this.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15d3d0a3Bjc3dpc2R3cmZxemNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTQzOTgsImV4cCI6MjA4Njg3MDM5OH0.XEzvjC7PmDG6uEhiYzo8HgK564WXKUi94LNHaS6jkQs';
                this.supabase        = null;
                this.participants    = [];
                this.competition     = null;
                this.timerActive     = false;
                this.timeRemaining   = 7200;
                this.timerInterval   = null;
                this.realtimeChannel = null;
                this.recentActivity  = [];
                this.areas = ['algebra', 'geometry', 'calculus', 'trigonometry', 'mental-calc', 'puzzles'];
                this.areaNames = {
                    'algebra': '√Ålgebra', 'geometry': 'Geometr√≠a', 'calculus': 'C√°lculo',
                    'trigonometry': 'Trigonometr√≠a', 'mental-calc': 'C√°lculo Mental', 'puzzles': 'Acertijos'
                };
                this.areaIcons = {
                    'algebra': 'fas fa-square-root-alt', 'geometry': 'fas fa-shapes',
                    'calculus': 'fas fa-infinity', 'trigonometry': 'fas fa-wave-square',
                    'mental-calc': 'fas fa-brain', 'puzzles': 'fas fa-puzzle-piece'
                };
                this.init();
            }

            async init() {
                this.supabase = window.supabase.createClient(this.SUPABASE_URL, this.SUPABASE_ANON_KEY);
                await this.loadData();
                this.setupRealtime();
                this.startTimer();
                // Fallback: actualizar cada 30 segundos
                setInterval(() => this.loadData(), 30000);
            }

            async loadData() {
                // Cargar competencia activa
                const { data: compData } = await this.supabase.rpc('get_active_competition');
                if (compData && compData.length > 0) {
                    this.competition = compData[0];
                }

                if (!this.competition) {
                    this.participants = [];
                    this.updateLeaderboard();
                    return;
                }

                // Cargar participantes
                const { data: parts } = await this.supabase
                    .from('competition_participants')
                    .select('*')
                    .eq('competition_id', this.competition.id)
                    .eq('is_active', true)
                    .order('total_score', { ascending: false });

                this.participants = (parts || []).map((p, i) => ({
                    ...p,
                    currentRank:    i + 1,
                    previousRank:   i + 1,
                    // Aliases para compatibilidad con m√©todos de UI
                    totalScore:     p.total_score,
                    problemsSolved: p.problems_solved,
                    lastActivity:   new Date(p.last_activity).getTime()
                }));

                // Actividad reciente: √∫ltimos participantes activos
                this.recentActivity = [...this.participants]
                    .sort((a, b) => b.lastActivity - a.lastActivity)
                    .slice(0, 6)
                    .map(p => ({
                        participant: p.name,
                        area: Object.entries(p.scores || {})
                            .sort((a, b) => b[1] - a[1])[0]?.[0] || 'algebra',
                        points: p.total_score,
                        time: p.lastActivity
                    }));

                this.updateTimerState();
                this.updateLeaderboard();
                this.updateAreaPerformance();
                this.updateRecords();
                this.updateRecentActivity();
            }

            setupRealtime() {
                if (!this.competition) return;

                this.realtimeChannel = this.supabase
                    .channel('leaderboard_realtime')
                    .on('postgres_changes', {
                        event: '*', schema: 'public', table: 'competition_participants',
                        filter: `competition_id=eq.${this.competition.id}`
                    }, () => this.loadData())
                    .on('postgres_changes', {
                        event: '*', schema: 'public', table: 'competitions',
                        filter: `id=eq.${this.competition.id}`
                    }, (payload) => {
                        const comp = payload.new;
                        this.competition = { ...this.competition, ...comp };
                        this.updateTimerState();
                        if (comp.status === 'ended') {
                            localStorage.removeItem('currentParticipant');
                            location.reload();
                        }
                    })
                    .subscribe();
            }

            updateTimerState() {
                if (!this.competition) return;
                if (this.competition.timer_started && this.competition.start_time) {
                    const elapsed = Math.floor((Date.now() - new Date(this.competition.start_time).getTime()) / 1000);
                    this.timeRemaining = Math.max(0, (this.competition.duration || 7200) - elapsed);
                    this.timerActive = true;
                } else {
                    this.timeRemaining = this.competition.duration || 7200;
                    this.timerActive = false;
                }
                const startButton = document.querySelector('[onclick="startCompetitionTimer()"]');
                if (startButton && this.competition.timer_started) {
                    startButton.innerHTML = '<i class="fas fa-check"></i> Timer Iniciado';
                    startButton.style.background = 'var(--success)';
                    startButton.disabled = true;
                }
            }

            showNoParticipantsMessage() {
                const tableContainer = document.getElementById('rankingsTable');
                tableContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; color: var(--primary);"></i>
                        <h3>Esperando Participantes</h3>
                        <p>Los participantes aparecer√°n aqu√≠ cuando ingresen con el c√≥digo de acceso</p>
                        <p style="margin-top: 1rem; font-size: 0.9rem;">La tabla se actualiza autom√°ticamente cada 5 segundos</p>
                    </div>
                `;
            }


            updateLeaderboard() {
                this.updateHeroStats();
                this.updatePodium();
                this.updateRankingsTable();
            }

            updatePodium() {
                for (let i = 0; i < 3; i++) {
                    const participant = this.participants[i];
                    if (participant) {
                        const avatarText = participant.name.split(' ').map(n => n[0]).join('');
                        
                        document.getElementById(`podium${i + 1}Avatar`).innerHTML = 
                            i === 0 ? '<div class="podium-crown">üëë</div>' + avatarText : avatarText;
                        document.getElementById(`podium${i + 1}Name`).textContent = participant.name;
                        document.getElementById(`podium${i + 1}School`).textContent = participant.school;
                        document.getElementById(`podium${i + 1}Score`).textContent = `${participant.totalScore} pts`;
                    } else {
                        // No participant for this position
                        document.getElementById(`podium${i + 1}Avatar`).innerHTML = i === 0 ? 
                            '<div class="podium-crown">üëë</div>?' : '?';
                        document.getElementById(`podium${i + 1}Name`).textContent = 'Esperando...';
                        document.getElementById(`podium${i + 1}School`).textContent = 'Participante';
                        document.getElementById(`podium${i + 1}Score`).textContent = '0 pts';
                    }
                }
            }

            updateHeroStats() {
                const totalParticipants = this.participants.length;
                
                if (totalParticipants === 0) {
                    document.getElementById('totalParticipants').textContent = '0';
                    document.getElementById('averageScore').textContent = '0';
                    document.getElementById('topScore').textContent = '0';
                    return;
                }

                const averageScore = Math.round(
                    this.participants.reduce((sum, p) => sum + p.totalScore, 0) / totalParticipants
                );
                const topScore = Math.max(...this.participants.map(p => p.totalScore));

                document.getElementById('totalParticipants').textContent = totalParticipants;
                document.getElementById('averageScore').textContent = averageScore;
                document.getElementById('topScore').textContent = topScore;
            }

            updateRankingsTable() {
                const tableContainer = document.getElementById('rankingsTable');
                
                if (this.participants.length === 0) {
                    this.showNoParticipantsMessage();
                    return;
                }

                tableContainer.innerHTML = '';

                this.participants.forEach((participant, index) => {
                    const rankItem = document.createElement('div');
                    rankItem.className = 'ranking-item';
                    if (index < 3) rankItem.classList.add('highlight');

                    const rankChange = this.getRankChange(participant);
                    const avatarText = participant.name.split(' ').map(n => n[0]).join('');

                    // Calculate total problems solved
                    const totalProblems = participant.problemsSolved ? 
                        Object.values(participant.problemsSolved).reduce((sum, count) => sum + count, 0) : 
                        participant.totalProblems || 0;

                    // Format last activity time
                    const lastActivityTime = participant.lastActivity ? 
                        this.formatTimeAgo(participant.lastActivity) : 'Hace tiempo';

                    rankItem.innerHTML = `
                        <div class="rank-position">
                            ${participant.currentRank}
                            <span class="rank-change ${rankChange.type}">
                                ${rankChange.icon} ${Math.abs(rankChange.value)}
                            </span>
                        </div>
                        <div class="participant-avatar">${avatarText}</div>
                        <div class="participant-details">
                            <div class="participant-name">${participant.name}</div>
                            <div class="participant-info">
                                <span><i class="fas fa-school"></i> ${participant.school}</span>
                                <span><i class="fas fa-fire"></i> Racha: ${participant.streak || 0}</span>
                                <span><i class="fas fa-tasks"></i> Problemas: ${totalProblems}</span>
                                <span><i class="fas fa-clock"></i> ${lastActivityTime}</span>
                            </div>
                        </div>
                        <div class="participant-score-section">
                            <div class="participant-total-score">${participant.totalScore}</div>
                            <div class="score-breakdown">
                                ${this.areas.map(area =>
                                    `<span class="area-score ${area}">${(participant.scores || {})[area] || 0}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;

                    tableContainer.appendChild(rankItem);
                });
            }

            formatTimeAgo(timestamp) {
                const now = Date.now();
                const diff = Math.floor((now - timestamp) / 1000);
                
                if (diff < 60) return 'Hace unos segundos';
                if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
                if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} h`;
                return `Hace ${Math.floor(diff / 86400)} d√≠as`;
            }

            getRankChange(participant) {
                const change = participant.previousRank - participant.currentRank;
                if (change > 0) {
                    return { type: 'up', icon: '‚Üë', value: change };
                } else if (change < 0) {
                    return { type: 'down', icon: '‚Üì', value: change };
                } else {
                    return { type: 'same', icon: '‚àí', value: 0 };
                }
            }

            updateRecentActivity() {
                const activityContainer = document.getElementById('activityList');
                activityContainer.innerHTML = '';

                if (this.recentActivity.length === 0) {
                    activityContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-clock" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>No hay actividad reciente</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem;">La actividad aparecer√° cuando los participantes resuelvan problemas</p>
                        </div>
                    `;
                    return;
                }

                this.recentActivity.slice(0, 6).forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';

                    const timeAgo = this.formatTimeAgo(activity.time);
                    const areaName = this.areaNames[activity.area] || activity.area;
                    const difficultyColor = activity.difficulty === 'hard' ? '#ff6b6b' : 
                                          activity.difficulty === 'medium' ? '#ffe066' : '#4ecdc4';

                    activityItem.innerHTML = `
                        <div class="activity-icon" style="background: ${difficultyColor};">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <strong>${activity.participant}</strong> gan√≥ ${activity.points} pts en ${areaName}
                                ${activity.difficulty ? `<span style="font-size: 0.8em; color: ${difficultyColor};">(${activity.difficulty})</span>` : ''}
                            </div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    `;

                    activityContainer.appendChild(activityItem);
                });
            }

            updateAreaPerformance() {
                const areaContainer = document.getElementById('areaPerformance');
                areaContainer.innerHTML = '';

                if (this.participants.length === 0) {
                    areaContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Sin datos de rendimiento</p>
                            <p style="font-size: 0.8rem;">Los datos aparecer√°n cuando haya participantes activos</p>
                        </div>
                    `;
                    return;
                }

                this.areas.forEach(area => {
                    const areaScores = this.participants
                        .map(p => (p.scores || {})[area] || 0)
                        .filter(score => score > 0);
                    
                    const average = areaScores.length > 0 ? 
                        Math.round(areaScores.reduce((sum, score) => sum + score, 0) / areaScores.length) : 0;
                    
                    const participantsCount = areaScores.length;

                    const areaItem = document.createElement('div');
                    areaItem.className = 'area-item';

                    areaItem.innerHTML = `
                        <div class="area-info">
                            <i class="${this.areaIcons[area]} area-icon-small"></i>
                            <span>${this.areaNames[area]}</span>
                        </div>
                        <div class="area-stats-right">
                            <div class="area-average">${average} pts</div>
                            <div class="area-participants">${participantsCount} participantes</div>
                        </div>
                    `;

                    areaContainer.appendChild(areaItem);
                });
            }

            updateRecords() {
                if (this.participants.length === 0) {
                    document.getElementById('bestTime').textContent = '--:--';
                    document.getElementById('bestStreak').textContent = '0';
                    document.getElementById('mostActive').textContent = '-';
                    return;
                }

                // Calculate real records
                const bestTime = '02:34'; // This would need real timing data
                const bestStreak = Math.max(...this.participants.map(p => p.streak || 0));
                
                const mostActiveParticipant = this.participants.reduce((prev, current) => {
                    const prevProblems = prev.problemsSolved ? 
                        Object.values(prev.problemsSolved).reduce((sum, count) => sum + count, 0) : prev.totalProblems || 0;
                    const currentProblems = current.problemsSolved ? 
                        Object.values(current.problemsSolved).reduce((sum, count) => sum + count, 0) : current.totalProblems || 0;
                    
                    return currentProblems > prevProblems ? current : prev;
                }, this.participants[0]);

                document.getElementById('bestTime').textContent = bestTime;
                document.getElementById('bestStreak').textContent = bestStreak;
                document.getElementById('mostActive').textContent = mostActiveParticipant ? 
                    mostActiveParticipant.name.split(' ')[0] : '-';
            }

            startTimer() {
                this.updateTimerDisplay();
                this.timerInterval = setInterval(() => {
                    if (this.timerActive && this.timeRemaining > 0) {
                        this.timeRemaining--;
                    }
                    this.updateTimerDisplay();
                }, 1000);
            }

            updateTimerDisplay() {
                const hours   = Math.floor(this.timeRemaining / 3600);
                const minutes = Math.floor((this.timeRemaining % 3600) / 60);
                const seconds = this.timeRemaining % 60;
                const display = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                const el = document.getElementById('timeRemaining');
                if (!el) return;
                if (!this.timerActive) {
                    el.textContent = '‚è≥ ' + display;
                    el.style.color = '#ffa726';
                    el.style.animation = 'waitingPulse 2s infinite';
                } else {
                    el.textContent = display;
                    el.style.animation = 'none';
                    el.style.color = '#4ecdc4';
                }
            }

            async refreshLeaderboard() {
                const refreshBtn  = document.getElementById('refreshText');
                const loadingIcon = document.getElementById('refreshLoading');
                refreshBtn.style.display    = 'none';
                loadingIcon.style.display   = 'inline-block';
                await this.loadData();
                refreshBtn.style.display    = 'inline';
                loadingIcon.style.display   = 'none';
            }
        }

        // Initialize the live leaderboard
        const liveLeaderboard = new LiveLeaderboard();

        function refreshLeaderboard() {
            liveLeaderboard.refreshLeaderboard();
        }

        // Iniciar cron√≥metro ‚Äî Supabase
        async function startCompetitionTimer() {
            const lb = liveLeaderboard;
            if (!lb.competition) {
                await lb.loadData();
            }
            if (!lb.competition) {
                alert('‚ö†Ô∏è No se pudo conectar. Recarga la p√°gina.');
                return;
            }

            const accessCode = prompt('üéØ INICIAR CRON√ìMETRO ‚Äî SOLO PROFESOR üéØ\n\nIngresa el c√≥digo del profesor:');
            if (!accessCode) return;

            const partCount = lb.participants.length;
            if (partCount === 0) {
                alert('‚ö†Ô∏è No hay participantes a√∫n.\n\nEspera a que al menos un estudiante ingrese.');
                return;
            }

            if (!confirm(`üöÄ INICIAR COMPETENCIA\n\nParticipantes: ${partCount}\nDuraci√≥n: 2 horas\n\n¬øIniciar ahora?`)) return;

            const { data, error } = await lb.supabase.rpc('start_competition_timer', {
                p_prof_code:      accessCode.toUpperCase(),
                p_competition_id: lb.competition.id
            });

            if (error || !data || !data.success) {
                alert('‚ùå ' + (data?.error || 'C√≥digo incorrecto o error.'));
                return;
            }
            alert('‚úÖ ¬°Cron√≥metro iniciado! Todos los participantes han sido notificados.');
        }

        // Reiniciar competencia ‚Äî Supabase
        async function resetCompetition() {
            const lb = liveLeaderboard;
            const accessCode = prompt('üîí ACCESO RESTRINGIDO ‚Äî SOLO PROFESOR\n\nIngresa el c√≥digo del profesor:');
            if (!accessCode) return;

            if (!confirm('‚ö†Ô∏è ADVERTENCIA\n\nEsto eliminar√° TODOS los datos:\n‚Ä¢ Participantes\n‚Ä¢ Puntuaciones\n\n¬øContinuar?')) return;
            if (!confirm('üî• √öLTIMA CONFIRMACI√ìN\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øReiniciar completamente?')) return;

            const { data, error } = await lb.supabase.rpc('reset_competition', {
                p_prof_code: accessCode.toUpperCase()
            });

            if (error || !data || !data.success) {
                alert('‚ùå ' + (data?.error || 'C√≥digo incorrecto o error.'));
                return;
            }

            localStorage.removeItem('currentParticipant');
            alert('‚úÖ Competencia reiniciada. La p√°gina se recargar√°.');
            location.reload();
        }

        // Auto-refresh cada 5 minutos para evitar problemas de memoria
        setTimeout(() => location.reload(), 300000);
    </script>
</body>
</html>