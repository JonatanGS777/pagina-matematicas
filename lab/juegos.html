<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATH ARENA â€” Competencia Multijugador</title>

    <!-- Orbitron Â· Space Grotesk Â· DM Mono -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VARIABLES â€” NEON ARCADE PALETTE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
        --bg-void:    #04040d;
        --bg-surface: #09091a;
        --bg-card:    #0e0e22;
        --bg-raised:  #14142e;

        --cyan:   #00f5ff;
        --pink:   #ff006e;
        --yellow: #ffe600;
        --green:  #00ff88;
        --orange: #ff7c00;

        --text-bright: #eeeeff;
        --text-mid:    #8888bb;
        --text-dim:    #44445a;

        --glow-c: 0 0 8px #00f5ff, 0 0 24px #00f5ff55, 0 0 50px #00f5ff22;
        --glow-p: 0 0 8px #ff006e, 0 0 24px #ff006e55, 0 0 50px #ff006e22;
        --glow-y: 0 0 8px #ffe600, 0 0 24px #ffe60055;
        --glow-g: 0 0 8px #00ff88, 0 0 24px #00ff8855;

        --font-d: 'Orbitron',      monospace;
        --font-b: 'Space Grotesk', sans-serif;
        --font-m: 'DM Mono',       monospace;
    }

    /* â•â•â•â•â•â•â•â•â•â• RESET â•â•â•â•â•â•â•â•â•â• */
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    html { height:100%; }
    body {
        font-family: var(--font-b);
        background: var(--bg-void);
        color: var(--text-bright);
        min-height: 100vh;
        overflow-x: hidden;
    }
    body::before {
        content:''; position:fixed; inset:0;
        background: repeating-linear-gradient(
            0deg, transparent, transparent 2px, rgba(0,0,0,.07) 2px, rgba(0,0,0,.07) 4px
        );
        pointer-events:none; z-index:9999;
    }

    /* â•â•â•â•â•â•â•â•â•â• BG GRID â•â•â•â•â•â•â•â•â•â• */
    #arena-bg { position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
    #arena-bg::before {
        content:''; position:absolute; inset:0;
        background-image:
            linear-gradient(var(--text-dim) 1px, transparent 1px),
            linear-gradient(90deg, var(--text-dim) 1px, transparent 1px);
        background-size:44px 44px; opacity:.2;
        animation: gPulse 8s ease-in-out infinite;
    }
    #arena-bg::after {
        content:''; position:absolute; inset:0;
        background: radial-gradient(ellipse 80% 60% at 50% 50%, rgba(0,245,255,.04) 0%, transparent 70%);
    }
    @keyframes gPulse { 0%,100%{opacity:.2;} 50%{opacity:.08;} }

    /* â•â•â•â•â•â•â•â•â•â• PARTICLES â•â•â•â•â•â•â•â•â•â• */
    #particles { position:fixed; inset:0; z-index:0; pointer-events:none; }
    .ptcl {
        position:absolute; border-radius:50%; opacity:0;
        animation: ptclFloat var(--dur,15s) var(--dly,0s) linear infinite;
    }
    @keyframes ptclFloat {
        0%   { transform:translateY(100vh) translateX(0); opacity:0; }
        10%  { opacity:.55; }
        90%  { opacity:.55; }
        100% { transform:translateY(-10vh) translateX(var(--drft,60px)); opacity:0; }
    }

    /* â•â•â•â•â•â•â•â•â•â• SCREENS â•â•â•â•â•â•â•â•â•â• */
    .scr { position:relative; z-index:1; display:none; min-height:100vh; padding:2rem; }
    .scr.on { display:flex; flex-direction:column; align-items:center; justify-content:center; }

    /* â•â•â•â•â•â•â•â•â•â• TYPOGRAPHY â•â•â•â•â•â•â•â•â•â• */
    .title-main {
        font-family: var(--font-d);
        font-size: clamp(3rem, 9vw, 5.5rem);
        font-weight: 900; letter-spacing:.12em;
        color: var(--cyan); text-shadow: var(--glow-c);
        text-transform: uppercase;
        animation: flicker 6s infinite;
        line-height:1; text-align:center;
    }
    @keyframes flicker {
        0%,92%,100% { opacity:1;   text-shadow:var(--glow-c); }
        93%          { opacity:.7;  text-shadow:none; }
        94%          { opacity:1;   text-shadow:var(--glow-c); }
        97%          { opacity:.85; }
    }
    .title-sub {
        font-family: var(--font-d);
        font-size: clamp(.5rem, 1.3vw, .7rem);
        letter-spacing:.4em; color: var(--text-mid);
        text-transform:uppercase; text-align:center; margin-top:.5rem;
    }
    .label {
        font-family:var(--font-d); font-size:.58rem;
        letter-spacing:.22em; color:var(--text-dim); text-transform:uppercase;
    }

    /* â•â•â•â•â•â•â•â•â•â• CARD â•â•â•â•â•â•â•â•â•â• */
    .card {
        background:var(--bg-card); border:1px solid rgba(0,245,255,.15);
        border-radius:4px; padding:1.75rem;
        position:relative; width:100%; overflow:hidden;
    }
    .card::before {
        content:''; position:absolute; top:0; left:0; right:0; height:1px;
        background:linear-gradient(90deg, transparent, var(--cyan), transparent);
        animation: scanLine 4s linear infinite;
    }
    @keyframes scanLine { 0%{transform:translateX(-100%); opacity:.5;} 100%{transform:translateX(100%); opacity:.5;} }

    /* â•â•â•â•â•â•â•â•â•â• INPUTS â•â•â•â•â•â•â•â•â•â• */
    .inp {
        width:100%; padding:.9rem 1.3rem;
        background:var(--bg-surface);
        border:1px solid rgba(0,245,255,.22); border-radius:2px;
        color:var(--text-bright); font-family:var(--font-b); font-size:1rem;
        outline:none; transition: border-color .2s, box-shadow .2s;
    }
    .inp::placeholder { color:var(--text-dim); }
    .inp:focus { border-color:var(--cyan); box-shadow:0 0 0 1px var(--cyan), inset 0 0 18px rgba(0,245,255,.04); }
    .inp-code { text-align:center; font-family:var(--font-d); font-size:2.2rem; letter-spacing:.4em; text-transform:uppercase; }

    /* â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â• */
    .btn {
        font-family:var(--font-d); font-size:.72rem; font-weight:700;
        letter-spacing:.15em; text-transform:uppercase;
        padding:.85rem 2rem; border:none; border-radius:3px;
        cursor:pointer; transition: transform .12s, box-shadow .12s, opacity .12s;
        position:relative; overflow:hidden;
    }
    .btn::after { content:''; position:absolute; inset:0; background:rgba(255,255,255,.08); opacity:0; transition:opacity .15s; }
    .btn:hover:not(:disabled)::after { opacity:1; }
    .btn:active:not(:disabled) { transform:scale(.97); }
    .btn:disabled { opacity:.35; cursor:not-allowed; }
    .btn-c { background:var(--cyan);  color:var(--bg-void); box-shadow:var(--glow-c); }
    .btn-g { background:var(--green); color:var(--bg-void); box-shadow:var(--glow-g); }
    .btn-p { background:var(--pink);  color:#fff;           box-shadow:var(--glow-p); }
    .btn-o { background:transparent;  color:var(--cyan);    border:1px solid rgba(0,245,255,.4); }
    .btn-w { width:100%; }
    .btn-group { display:flex; gap:.7rem; }

    /* â•â•â•â•â•â•â•â•â•â• CONNECTION BADGE â•â•â•â•â•â•â•â•â•â• */
    #conn-badge {
        position:fixed; top:1rem; right:1rem; z-index:300;
        font-family:var(--font-d); font-size:.55rem; letter-spacing:.1em;
        padding:.28rem .65rem; border-radius:100px;
        display:flex; align-items:center; gap:.4rem; transition:all .3s;
    }
    .dot { width:6px; height:6px; border-radius:50%; }
    #conn-badge.connected    { background:rgba(0,255,136,.12); color:var(--green); border:1px solid rgba(0,255,136,.3); }
    #conn-badge.connected    .dot { background:var(--green); box-shadow:0 0 5px var(--green); animation:blink 2s infinite; }
    #conn-badge.disconnected { background:rgba(255,0,110,.12); color:var(--pink);  border:1px solid rgba(255,0,110,.3); }
    #conn-badge.disconnected .dot { background:var(--pink); }
    #conn-badge.connecting   { background:rgba(255,230,0,.12); color:var(--yellow); border:1px solid rgba(255,230,0,.3); }
    #conn-badge.connecting   .dot { background:var(--yellow); animation:blink .5s infinite; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:.2;} }

    /* â•â•â•â•â•â•â•â•â•â• TOASTS â•â•â•â•â•â•â•â•â•â• */
    #toasts { position:fixed; bottom:2rem; left:50%; transform:translateX(-50%); z-index:400; display:flex; flex-direction:column; align-items:center; gap:.4rem; }
    .toast {
        font-family:var(--font-d); font-size:.65rem; letter-spacing:.1em;
        padding:.6rem 1.4rem; border-radius:2px; white-space:nowrap;
        animation: tIn .3s ease-out;
    }
    @keyframes tIn { from{transform:translateY(16px); opacity:0;} to{transform:translateY(0); opacity:1;} }
    .toast.i { background:rgba(0,245,255,.12); color:var(--cyan);  border:1px solid rgba(0,245,255,.28); }
    .toast.e { background:rgba(255,0,110,.12);  color:var(--pink);  border:1px solid rgba(255,0,110,.28); }
    .toast.s { background:rgba(0,255,136,.12);  color:var(--green); border:1px solid rgba(0,255,136,.28); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 1 â€” BIENVENIDA
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .welcome-wrap {
        max-width:440px; width:100%;
        display:flex; flex-direction:column; align-items:center; gap:1.8rem;
    }
    .diff-group { display:grid; grid-template-columns:repeat(2,1fr); gap:.45rem; width:100%; }
    .diff-btn {
        font-family:var(--font-d); font-size:.58rem; letter-spacing:.1em;
        padding:.65rem .3rem; border-radius:3px;
        border:1px solid rgba(255,255,255,.1); background:var(--bg-surface);
        color:var(--text-mid); cursor:pointer; text-align:center; text-transform:uppercase;
        transition:all .2s;
    }
    .diff-btn:hover { border-color:var(--cyan); color:var(--cyan); }
    .diff-btn.active { border-color:var(--cyan); color:var(--cyan); background:rgba(0,245,255,.08); box-shadow:var(--glow-c); }
    .diff-btn[data-diff="hard"].active   { border-color:var(--orange); color:var(--orange); background:rgba(255,124,0,.08); }
    .diff-btn[data-diff="expert"].active { border-color:var(--pink);   color:var(--pink);   background:rgba(255,0,110,.08); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 3 â€” LOBBY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .room-code-box {
        font-family:var(--font-d);
        font-size:clamp(2.5rem, 7vw, 4.5rem);
        font-weight:900; letter-spacing:.35em;
        color:var(--yellow); text-shadow:var(--glow-y);
        text-align:center; padding:1.2rem 2rem;
        background:var(--bg-surface);
        border:2px dashed rgba(255,230,0,.35); border-radius:3px;
        cursor:pointer; transition:all .2s;
    }
    .room-code-box:hover { border-color:var(--yellow); }
    .room-hint { font-size:.72rem; color:var(--text-mid); text-align:center; margin-top:.4rem; }

    #lobby-grid {
        display:grid; grid-template-columns:repeat(auto-fill, minmax(115px,1fr));
        gap:.6rem; width:100%; margin:.9rem 0;
    }
    .p-slot {
        display:flex; flex-direction:column; align-items:center; gap:.35rem;
        padding:.85rem .4rem;
        background:var(--bg-surface); border:1px solid rgba(0,245,255,.12);
        border-radius:3px; animation: slotIn .3s ease-out both;
    }
    .p-slot.host-slot { border-color:rgba(255,230,0,.35); }
    @keyframes slotIn { from{transform:scale(.75); opacity:0;} to{transform:scale(1); opacity:1;} }
    .slot-avatar { font-size:1.7rem; }
    .slot-name   { font-size:.68rem; font-weight:600; text-align:center; word-break:break-word; }
    .slot-badge  { font-family:var(--font-d); font-size:.5rem; letter-spacing:.1em; color:var(--yellow); }

    .wait-pulse {
        font-family:var(--font-d); font-size:.62rem; letter-spacing:.3em;
        color:var(--text-dim); text-align:center;
        animation: wPulse 2.2s ease-in-out infinite;
    }
    @keyframes wPulse { 0%,100%{opacity:.3;} 50%{opacity:1; color:var(--cyan);} }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 4 â€” JUEGO (2 columnas)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #scr-game { display:none; min-height:100vh; }
    #scr-game.on {
        display:flex; flex-direction:row;
        align-items:stretch; justify-content:center;
        gap:.8rem; padding:.8rem;
    }

    /* Sidebar izquierdo */
    .g-sidebar { width:210px; flex-shrink:0; display:flex; flex-direction:column; gap:.6rem; }

    .lb-wrap {
        background:var(--bg-card); border:1px solid rgba(0,245,255,.14);
        border-radius:3px; overflow:hidden; flex:1;
    }
    .lb-head {
        font-family:var(--font-d); font-size:.55rem; letter-spacing:.2em;
        color:var(--text-dim); text-transform:uppercase;
        padding:.6rem .8rem .35rem; border-bottom:1px solid rgba(255,255,255,.04);
    }
    .lb-row {
        display:flex; align-items:center; gap:.4rem;
        padding:.52rem .8rem; border-bottom:1px solid rgba(255,255,255,.03);
        animation: lbIn .25s ease-out both; transition:background .3s;
    }
    @keyframes lbIn { from{transform:translateX(-8px); opacity:0;} to{transform:translateX(0); opacity:1;} }
    .lb-row:last-child { border-bottom:none; }
    .lb-row.me         { background:rgba(0,245,255,.05); }
    .lb-row.eliminated { opacity:.3; }
    .lb-rank  { font-family:var(--font-d); font-size:.62rem; width:14px; text-align:center; color:var(--text-dim); }
    .lb-rank.r1 { color:#ffd700; } .lb-rank.r2 { color:#c0c0c0; } .lb-rank.r3 { color:#cd7f32; }
    .lb-av    { font-size:.95rem; }
    .lb-info  { flex:1; min-width:0; }
    .lb-name  { font-size:.67rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .lb-pts   { font-family:var(--font-m); font-size:.58rem; color:var(--text-mid); }
    .lb-lives { font-size:.65rem; line-height:1; }

    /* Box de mis vidas */
    .my-lives-box {
        padding:.65rem .8rem;
        background:var(--bg-card); border:1px solid rgba(0,245,255,.14); border-radius:3px;
    }
    .my-lives-row { display:flex; gap:.25rem; margin-top:.3rem; }
    .heart { font-size:1.25rem; transition:all .3s; display:inline-block; }
    .heart.dead { filter:grayscale(1); opacity:.22; transform:scale(.8); }
    .heart.breaking { animation: hBreak .55s ease-out forwards; }
    @keyframes hBreak {
        0%  { transform:scale(1.4) rotate(-10deg); }
        40% { transform:scale(1.6) rotate(20deg);  }
        70% { transform:scale(.5)  rotate(40deg);  opacity:.4; }
        100%{ transform:scale(.8); filter:grayscale(1); opacity:.22; }
    }

    /* Ãrea principal */
    .g-main { flex:1; max-width:680px; display:flex; flex-direction:column; gap:.8rem; }

    /* Top bar */
    .g-topbar {
        display:flex; align-items:center; justify-content:space-between;
        padding:.6rem 1rem;
        background:var(--bg-card); border:1px solid rgba(0,245,255,.14); border-radius:3px;
    }
    .q-badge { font-family:var(--font-d); font-size:.68rem; letter-spacing:.12em; color:var(--text-mid); }
    .q-badge span { color:var(--cyan); font-size:.88rem; }
    .room-pill {
        font-family:var(--font-d); font-size:.55rem; letter-spacing:.15em;
        padding:.18rem .65rem; border:1px solid rgba(255,230,0,.3);
        border-radius:100px; color:var(--yellow);
    }

    /* Timer ring */
    .timer-ring-wrap { position:relative; display:flex; align-items:center; justify-content:center; }
    .timer-svg   { width:64px; height:64px; transform:rotate(-90deg); }
    .t-track     { fill:none; stroke:rgba(255,255,255,.07); stroke-width:5; }
    .t-ring      {
        fill:none; stroke:var(--cyan); stroke-width:5; stroke-linecap:round;
        stroke-dasharray:220; stroke-dashoffset:0;
        transition: stroke-dashoffset .1s linear, stroke .3s;
    }
    .t-ring.warn { stroke:var(--yellow); }
    .t-ring.crit { stroke:var(--pink); animation: tPulse .45s infinite; }
    @keyframes tPulse { 0%,100%{filter:drop-shadow(0 0 3px var(--pink));} 50%{filter:drop-shadow(0 0 10px var(--pink));} }
    .t-num { position:absolute; font-family:var(--font-d); font-size:1.1rem; font-weight:700; color:var(--text-bright); transition:color .3s; }

    /* Tarjeta de pregunta */
    .q-card {
        background:var(--bg-card); border:1px solid rgba(0,245,255,.18); border-radius:4px;
        padding:2.5rem 2rem; flex:1; min-height:150px;
        display:flex; align-items:center; justify-content:center;
        position:relative; overflow:hidden;
    }
    .q-card::after { content:''; position:absolute; inset:0; background:linear-gradient(135deg, rgba(0,245,255,.03), transparent 60%); pointer-events:none; }
    .q-text {
        font-family:var(--font-d); font-size:clamp(1.5rem, 3.5vw, 2.6rem);
        font-weight:700; color:var(--text-bright);
        text-align:center; letter-spacing:.03em; line-height:1.35;
        animation: qReveal .35s cubic-bezier(.2,.8,.4,1) both;
    }
    @keyframes qReveal { from{opacity:0; transform:scale(.88) translateY(10px); filter:blur(5px);} to{opacity:1; transform:scale(1) translateY(0); filter:blur(0);} }
    .q-card.shake     { animation: shk .45s ease; }
    .q-card.flash-ok  { animation: flashOk  .55s ease; }
    .q-card.flash-bad { animation: flashBad .55s ease; }
    @keyframes shk { 0%,100%{transform:translateX(0);} 20%{transform:translateX(-7px);} 40%{transform:translateX(7px);} 60%{transform:translateX(-4px);} 80%{transform:translateX(4px);} }
    @keyframes flashOk  { 0%,100%{border-color:rgba(0,245,255,.18); background:var(--bg-card);} 45%,70%{border-color:var(--green); background:rgba(0,255,136,.07); box-shadow:0 0 30px rgba(0,255,136,.2);} }
    @keyframes flashBad { 0%,100%{border-color:rgba(0,245,255,.18); background:var(--bg-card);} 45%,70%{border-color:var(--pink);  background:rgba(255,0,110,.07);  box-shadow:0 0 30px rgba(255,0,110,.2);} }

    /* Botones de respuesta */
    .ans-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:.6rem; }
    .ans-btn {
        font-family:var(--font-d); font-size:clamp(.8rem, 2vw, .98rem);
        font-weight:700; letter-spacing:.05em;
        padding:1.1rem; background:var(--bg-raised);
        border:2px solid rgba(0,245,255,.14); border-radius:3px;
        color:var(--text-bright); cursor:pointer; transition:all .15s ease;
        text-align:center; animation: aReveal .3s ease-out both;
    }
    .ans-btn:nth-child(1){ animation-delay:.04s; } .ans-btn:nth-child(2){ animation-delay:.09s; }
    .ans-btn:nth-child(3){ animation-delay:.14s; } .ans-btn:nth-child(4){ animation-delay:.19s; }
    @keyframes aReveal { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
    .ans-ltr { display:inline-block; width:1.25rem; height:1.25rem; line-height:1.25rem; text-align:center; border-radius:50%; margin-right:.45rem; background:rgba(0,245,255,.1); font-size:.6rem; color:var(--cyan); }
    .ans-btn:hover:not(:disabled) { background:rgba(0,245,255,.08); border-color:var(--cyan); color:var(--cyan); transform:translateY(-2px); box-shadow:0 4px 18px rgba(0,245,255,.12); }
    .ans-btn:disabled { cursor:not-allowed; }
    .ans-btn.selected { background:rgba(0,245,255,.1);  border-color:var(--cyan);  color:var(--cyan); }
    .ans-btn.correct  { background:rgba(0,255,136,.12); border-color:var(--green); color:var(--green); text-shadow:var(--glow-g); }
    .ans-btn.wrong    { background:rgba(255,0,110,.1);  border-color:var(--pink);  color:var(--pink); }

    .status-line { font-family:var(--font-d); font-size:.6rem; letter-spacing:.12em; text-align:center; color:var(--text-dim); padding:.25rem; min-height:1.5rem; }
    .status-line.answered { color:var(--cyan); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       OVERLAY entre rondas
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #round-overlay {
        position:fixed; inset:0; z-index:500;
        background:rgba(4,4,13,.93);
        display:none; flex-direction:column;
        align-items:center; justify-content:center; gap:1.1rem;
    }
    #round-overlay.on { display:flex; }
    .verdict {
        font-family:var(--font-d); font-size:clamp(2rem, 7vw, 4.5rem);
        font-weight:900; letter-spacing:.1em;
        animation: vPop .38s cubic-bezier(.175,.885,.32,1.275);
    }
    .verdict.ok   { color:var(--green);  text-shadow:var(--glow-g); }
    .verdict.bad  { color:var(--pink);   text-shadow:var(--glow-p); }
    .verdict.time { color:var(--yellow); text-shadow:var(--glow-y); }
    @keyframes vPop { from{transform:scale(.3); opacity:0;} to{transform:scale(1); opacity:1;} }
    .pts-pop { font-family:var(--font-d); font-size:2.1rem; font-weight:900; animation: ptsUp .45s ease-out; }
    @keyframes ptsUp { from{transform:translateY(18px); opacity:0;} to{transform:translateY(0); opacity:1;} }
    .correct-reveal { font-family:var(--font-d); font-size:.9rem; color:var(--text-mid); }
    .correct-reveal span { color:var(--yellow); text-shadow:var(--glow-y); }
    .life-lost { font-family:var(--font-d); font-size:1.3rem; color:var(--pink); text-shadow:var(--glow-p); animation:vPop .4s ease-out; }
    .nxt-cd { font-family:var(--font-d); font-size:.65rem; letter-spacing:.2em; color:var(--text-dim); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 5 â€” RESULTADOS FINALES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .podium-row { display:flex; align-items:flex-end; justify-content:center; gap:.9rem; margin:1.2rem 0; }
    .pod { display:flex; flex-direction:column; align-items:center; gap:.35rem; }
    .pod-av    { font-size:2rem; }
    .pod-name  { font-size:.75rem; font-weight:700; text-align:center; max-width:85px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .pod-score { font-family:var(--font-m); font-size:.65rem; color:var(--text-mid); }
    .pod-block { border-radius:3px 3px 0 0; width:84px; display:flex; align-items:flex-end; justify-content:center; padding-bottom:.45rem; }
    .pod-block.p1 { height:100px; background:linear-gradient(180deg,#ffd700,#a07000); }
    .pod-block.p2 { height:68px;  background:linear-gradient(180deg,#c0c0c0,#707070); }
    .pod-block.p3 { height:48px;  background:linear-gradient(180deg,#cd7f32,#6b3800); }
    .pod-num { font-family:var(--font-d); font-size:1.5rem; font-weight:900; color:var(--bg-void); }

    .rank-row {
        display:flex; align-items:center; gap:.7rem;
        padding:.5rem 0; border-bottom:1px solid rgba(255,255,255,.04);
    }
    .rank-row:last-child { border-bottom:none; }
    .rk-n  { font-family:var(--font-d); font-size:.72rem; width:20px; text-align:center; }
    .rk-av { font-size:.95rem; }
    .rk-nm { flex:1; font-weight:600; font-size:.88rem; }
    .rk-pt { font-family:var(--font-m); font-size:.78rem; color:var(--text-mid); }
    .rk-lv { font-size:.72rem; }

    /* â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â• */
    @media (max-width:768px) {
        #scr-game.on { flex-direction:column; padding:.5rem; }
        .g-sidebar   { width:100%; flex-direction:row; overflow-x:auto; gap:.4rem; }
        .lb-wrap     { min-width:200px; flex:1; }
        .my-lives-box{ flex-shrink:0; }
        .g-main      { max-width:100%; }
        .ans-grid    { grid-template-columns:1fr; }
    }
    @media (max-width:480px) {
        .title-main { font-size:2.6rem; }
        .q-text     { font-size:1.4rem; }
        .verdict    { font-size:2rem; }
        .diff-group { grid-template-columns:repeat(2,1fr); }
    }
    </style>
</head>
<body>

<div id="arena-bg"></div>
<div id="particles"></div>

<!-- Badge de conexiÃ³n -->
<div id="conn-badge" class="connecting">
    <div class="dot"></div><span id="conn-txt">CONECTANDO</span>
</div>

<!-- Toasts -->
<div id="toasts"></div>

<!-- Overlay entre rondas -->
<div id="round-overlay">
    <div id="ov-verdict" class="verdict ok">Â¡CORRECTO!</div>
    <div id="ov-pts"     class="pts-pop"    style="color:var(--yellow);text-shadow:var(--glow-y);">+150 PTS</div>
    <div id="ov-ans"     class="correct-reveal">Respuesta: <span id="ov-ans-val">â€”</span></div>
    <div id="ov-life"    class="life-lost"  style="display:none;">ğŸ’” VIDA PERDIDA</div>
    <div id="ov-cd"      class="nxt-cd">SIGUIENTE EN <span id="ov-n">5</span>â€¦</div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANTALLA 1 â€” BIENVENIDA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scr-welcome" class="scr on">
    <div class="welcome-wrap">

        <div>
            <h1 class="title-main">MATH<br>ARENA</h1>
            <p class="title-sub">âš¡ Competencia MatemÃ¡tica en Tiempo Real âš¡</p>
        </div>

        <div class="card" style="display:flex;flex-direction:column;gap:1.2rem;">

            <!-- Nombre -->
            <div>
                <p class="label" style="margin-bottom:.5rem;">Nombre de combate</p>
                <input id="inp-name" type="text" class="inp" placeholder="TU NOMBRE..." maxlength="16" autocomplete="off">
            </div>

            <!-- Dificultad (sÃ³lo aplica al crear sala) -->
            <div>
                <p class="label" style="margin-bottom:.5rem;">Dificultad <span style="color:var(--text-dim);font-size:.5rem;">(solo al crear sala)</span></p>
                <div class="diff-group">
                    <button class="diff-btn active" data-diff="easy">ğŸŸ¢ FÃ¡cil</button>
                    <button class="diff-btn"        data-diff="medium">ğŸ”µ Medio</button>
                    <button class="diff-btn"        data-diff="hard">ğŸŸ  DifÃ­cil</button>
                    <button class="diff-btn"        data-diff="expert">ğŸ”´ Experto</button>
                </div>
            </div>

            <div class="btn-group">
                <button id="btn-create"  class="btn btn-c" style="flex:1;">
                    <i class="fas fa-plus" style="margin-right:.4rem;"></i>CREAR SALA
                </button>
                <button id="btn-join-go" class="btn btn-o" style="flex:1;">
                    <i class="fas fa-sign-in-alt" style="margin-right:.4rem;"></i>UNIRSE
                </button>
            </div>
        </div>

        <p style="font-family:var(--font-d);font-size:.5rem;letter-spacing:.16em;color:var(--text-dim);text-align:center;">
            â¤ï¸â¤ï¸â¤ï¸ Â· 3 VIDAS Â· SUMA Â· RESTA Â· MULTIPLICACIÃ“N Â· DIVISIÃ“N Â· POTENCIAS Â· RAÃCES Â· ORDEN
        </p>
    </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANTALLA 2 â€” UNIRSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scr-join" class="scr">
    <div style="max-width:360px;width:100%;display:flex;flex-direction:column;align-items:center;gap:1.5rem;">
        <h2 style="font-family:var(--font-d);font-size:1.3rem;font-weight:700;color:var(--cyan);letter-spacing:.15em;">UNIRSE A SALA</h2>
        <div class="card" style="display:flex;flex-direction:column;gap:1.1rem;">
            <p class="label" style="text-align:center;">CÃ³digo de sala</p>
            <input id="inp-code" type="text" class="inp inp-code" placeholder="ABC123" maxlength="6" autocomplete="off">
            <div class="btn-group">
                <button id="btn-back" class="btn btn-o" style="flex:1;">â† VOLVER</button>
                <button id="btn-join" class="btn btn-c" style="flex:1;">UNIRSE â†’</button>
            </div>
        </div>
    </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANTALLA 3 â€” LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scr-lobby" class="scr">
    <div style="max-width:640px;width:100%;display:flex;flex-direction:column;align-items:center;gap:1.4rem;">

        <!-- CÃ³digo de sala -->
        <div style="width:100%;text-align:center;">
            <p class="label">CÃ³digo de sala â€” comparte con tus estudiantes</p>
            <div id="lobby-code" class="room-code-box" title="Clic para copiar" style="margin-top:.4rem;">------</div>
            <p class="room-hint" id="lobby-copy-hint">ğŸ“‹ Clic para copiar</p>
        </div>

        <!-- Jugadores -->
        <div class="card" style="width:100%;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.65rem;">
                <p class="label">Jugadores conectados</p>
                <span id="lobby-count" style="font-family:var(--font-d);font-size:.68rem;color:var(--cyan);">0 / 30</span>
            </div>
            <div id="lobby-grid"></div>
        </div>

        <!-- Controles -->
        <div style="width:100%;display:flex;flex-direction:column;align-items:center;gap:.85rem;">
            <div id="lobby-msg" class="wait-pulse">ESPERANDO AL HOSTâ€¦</div>
            <button id="btn-start" class="btn btn-g" style="display:none;max-width:280px;width:100%;">
                <i class="fas fa-play" style="margin-right:.4rem;"></i>INICIAR COMBATE
            </button>
            <button id="btn-leave" class="btn btn-o" style="max-width:160px;width:100%;">SALIR</button>
        </div>
    </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANTALLA 4 â€” JUEGO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scr-game" class="scr">

    <!-- Sidebar: Scoreboard en vivo + Mis vidas -->
    <div class="g-sidebar">
        <div class="lb-wrap">
            <div class="lb-head">ğŸ† Scoreboard en vivo</div>
            <div id="live-lb"></div>
        </div>
        <div class="my-lives-box">
            <p class="label">Tus vidas</p>
            <div id="my-lives" class="my-lives-row">
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
            </div>
        </div>
    </div>

    <!-- Ãrea principal -->
    <div class="g-main">

        <!-- Top bar -->
        <div class="g-topbar">
            <div class="q-badge">PREGUNTA <span id="q-num">1</span>/<span id="q-tot">10</span></div>

            <div class="timer-ring-wrap">
                <svg class="timer-svg" viewBox="0 0 80 80">
                    <circle class="t-track" cx="40" cy="40" r="35"/>
                    <circle id="t-ring"  class="t-ring"  cx="40" cy="40" r="35"/>
                </svg>
                <span id="t-num" class="t-num">15</span>
            </div>

            <div id="room-pill" class="room-pill">---</div>
        </div>

        <!-- Pregunta -->
        <div class="q-card" id="q-card">
            <div id="q-text" class="q-text">Cargandoâ€¦</div>
        </div>

        <!-- Respuestas -->
        <div id="ans-grid" class="ans-grid"></div>

        <!-- Estado -->
        <div id="status-line" class="status-line">Selecciona una respuesta Â· usa A B C D</div>
    </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANTALLA 5 â€” RESULTADOS FINALES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scr-final" class="scr">
    <div style="max-width:600px;width:100%;display:flex;flex-direction:column;align-items:center;gap:1.4rem;">

        <h1 style="font-family:var(--font-d);font-size:clamp(2rem,6vw,3.5rem);font-weight:900;
                   letter-spacing:.12em;color:var(--pink);text-shadow:var(--glow-p);text-align:center;">
            COMBATE<br>TERMINADO
        </h1>

        <!-- Podio top 3 -->
        <div id="podium" class="podium-row"></div>

        <!-- ClasificaciÃ³n completa -->
        <div class="card" style="width:100%;">
            <p class="label" style="margin-bottom:.85rem;">ClasificaciÃ³n final</p>
            <div id="final-list"></div>
        </div>

        <div class="btn-group" style="flex-wrap:wrap;justify-content:center;">
            <button id="btn-again" class="btn btn-c">
                <i class="fas fa-redo" style="margin-right:.4rem;"></i>JUGAR DE NUEVO
            </button>
            <button id="btn-menu" class="btn btn-o">
                <i class="fas fa-home" style="margin-right:.4rem;"></i>MENÃš
            </button>
        </div>
    </div>
</div>


<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MATH ARENA â€” Motor Multijugador
   Socket.IO Â· 3 vidas Â· Scoreboard en vivo Â· Tiempo real
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function () {
'use strict';

/* â”€â”€â”€ CONSTANTES â”€â”€â”€ */
const CIRC  = 2 * Math.PI * 35;  // SVG ring r=35 â†’ â‰ˆ219.9
const LTRS  = ['A','B','C','D'];
const DIFF_SETTINGS = {
    easy  : { totalQuestions:15, questionTime:20, difficultyLevel:'easy' },
    medium: { totalQuestions:15, questionTime:15, difficultyLevel:'medium' },
    hard  : { totalQuestions:15, questionTime:12, difficultyLevel:'hard' },
    expert: { totalQuestions:15, questionTime:10, difficultyLevel:'hard' },
};

/* â”€â”€â”€ ESTADO â”€â”€â”€ */
const G = {
    socket     : null,
    myId       : '',
    myName     : '',
    roomCode   : '',
    isHost     : false,
    difficulty : 'easy',
    players    : [],
    pCount     : 0,
    lives      : {},    // { playerName: 0-3 }
    myLives    : 3,
    score      : 0,
    qNum       : 0,
    qTotal     : 15,
    hasAnswered: false,
    raf        : null,
    tLeft      : 15,
    tMax       : 15,
    ovTimer    : null,
};

/* â”€â”€â”€ PANTALLAS â”€â”€â”€ */
const SCR = {
    welcome: document.getElementById('scr-welcome'),
    join   : document.getElementById('scr-join'),
    lobby  : document.getElementById('scr-lobby'),
    game   : document.getElementById('scr-game'),
    final  : document.getElementById('scr-final'),
};

function show(name) {
    Object.entries(SCR).forEach(([k, el]) => {
        if (k === 'game') {
            el.style.display = (name === 'game') ? 'flex' : 'none';
            el.classList.toggle('on', name === 'game');
        } else {
            el.classList.toggle('on', k === name);
        }
    });
}

/* â”€â”€â”€ CONEXIÃ“N â”€â”€â”€ */
function setConn(status) {
    const b = document.getElementById('conn-badge');
    const t = document.getElementById('conn-txt');
    b.className = status;
    t.textContent = { connected:'EN LÃNEA', disconnected:'DESCONECTADO', connecting:'CONECTANDO' }[status];
}

/* â”€â”€â”€ PARTÃCULAS â”€â”€â”€ */
function initParticles() {
    const box  = document.getElementById('particles');
    const cols = ['#00f5ff','#ff006e','#ffe600','#00ff88'];
    for (let i = 0; i < 42; i++) {
        const p  = document.createElement('div');
        p.className = 'ptcl';
        const sz = 1 + Math.random() * 2.5;
        p.style.cssText = [
            `left:${Math.random()*100}%`,
            `width:${sz}px`, `height:${sz}px`,
            `background:${cols[i % cols.length]}`,
            `--dur:${12+Math.random()*18}s`,
            `--dly:${Math.random()*16}s`,
            `--drft:${(Math.random()*200-100)}px`,
        ].join(';');
        box.appendChild(p);
    }
}

/* â”€â”€â”€ SONIDO â”€â”€â”€ */
const sfx = (() => {
    let ctx = null;
    const C = () => { if (!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)(); return ctx; };
    const note = (hz, type, dur, vol=.1) => {
        try {
            const c=C(), o=c.createOscillator(), g=c.createGain();
            o.connect(g); g.connect(c.destination);
            o.type=type; o.frequency.value=hz;
            g.gain.setValueAtTime(vol, c.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, c.currentTime+dur);
            o.start(); o.stop(c.currentTime+dur);
        } catch(e) {}
    };
    return {
        correct : () => { note(523,'sine',.12); setTimeout(()=>note(659,'sine',.12),90); setTimeout(()=>note(784,'sine',.25),180); },
        wrong   : () => { note(200,'square',.25,.08); setTimeout(()=>note(140,'square',.25,.08),100); },
        click   : () => note(600,'sine',.06,.04),
        lifeLost: () => { note(280,'sawtooth',.4,.09); setTimeout(()=>note(180,'sawtooth',.4,.09),175); },
        start   : () => [261,329,392,523].forEach((f,i)=>setTimeout(()=>note(f,'sine',.18),i*90)),
        tick    : () => note(900,'sine',.03,.025),
        fanfare : () => [392,523,659,784,1047].forEach((f,i)=>setTimeout(()=>note(f,'sine',.28),i*70)),
    };
})();

/* â”€â”€â”€ TOAST â”€â”€â”€ */
function toast(msg, type='i', ms=3000) {
    const box = document.getElementById('toasts');
    const el  = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = msg;
    box.appendChild(el);
    setTimeout(() => {
        el.style.transition = 'all .3s';
        el.style.opacity    = '0';
        el.style.transform  = 'translateY(16px)';
        setTimeout(() => el.remove(), 320);
    }, ms);
}

/* â”€â”€â”€ SOCKET SETUP â”€â”€â”€ */
function connect() {
    const url = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:3002'
        : 'https://math-battle-server.onrender.com';
    G.socket   = io(url, { transports:['websocket','polling'] });

    G.socket.on('connect',       () => { G.myId = G.socket.id; setConn('connected'); });
    G.socket.on('disconnect',    () => setConn('disconnected'));
    G.socket.on('connect_error', () => setConn('disconnected'));

    /* â”€â”€ Sala â”€â”€ */
    G.socket.on('room-created', d => {
        G.roomCode = d.roomCode; G.isHost = true;
        G.players  = [d.player]; G.pCount  = 1;
        openLobby();
    });

    G.socket.on('room-joined', d => {
        G.roomCode = d.roomCode; G.isHost = false;
        G.players  = d.room.players; G.pCount = G.players.length;
        openLobby();
    });

    G.socket.on('player-joined', d => {
        if (Array.isArray(d?.room?.players)) {
            G.players = d.room.players; G.pCount = G.players.length;
        } else if (d?.player) {
            if (!G.players.some(p => p.id === d.player.id)) G.players.push(d.player);
            G.pCount = d.totalPlayers || G.players.length;
        }
        renderLobbyPlayers();
        toast(`${d.player?.name || 'Jugador'} entrÃ³ a la arena`, 'i');
    });

    G.socket.on('player-disconnected', d => {
        if (Array.isArray(d?.room?.players)) {
            G.players = d.room.players; G.pCount = G.players.length;
        }
        renderLobbyPlayers();
        renderLiveScoreboard();
        toast(`${d.playerName || 'Jugador'} abandonÃ³ la arena`, 'e');
    });

    /* â”€â”€ Juego â”€â”€ */
    G.socket.on('game-started', d => {
        G.qTotal  = d.totalQuestions || 15;
        G.myLives = 3;
        G.lives   = {};
        G.players.forEach(p => { G.lives[p.name] = 3; });
        updateMyLives();
        document.getElementById('q-tot').textContent = G.qTotal;
        sfx.start();
        // Mostrar mensaje de espera en el lobby sin cambiar de pantalla todavÃ­a
        const msg = document.getElementById('lobby-msg');
        if (msg) { msg.textContent = 'Â¡PrepÃ¡rate! La primera pregunta llega en instantesâ€¦'; msg.style.color = 'var(--cyan)'; }
    });

    G.socket.on('new-question', d => {
        document.getElementById('round-overlay').classList.remove('on');
        clearInterval(G.ovTimer);
        G.qNum        = d.questionNumber;
        G.hasAnswered = false;
        stopTimer();
        renderQuestion(d);
        show('game');

        // Si el jugador estÃ¡ eliminado (0 vidas), bloquear respuestas y auto-enviar vacÃ­o
        if (G.myLives <= 0) {
            G.hasAnswered = true;
            document.querySelectorAll('.ans-btn').forEach(b => b.disabled = true);
            const sl = document.getElementById('status-line');
            sl.textContent = 'ğŸ’€ ELIMINADO â€” observando la ronda';
            sl.className   = 'status-line';
            G.socket.emit('submit-answer', { roomCode: G.roomCode, answer: '', timeRemaining: 0 });
        }
    });

    G.socket.on('answer-result', d => {
        G.score = d.totalScore;
    });

    G.socket.on('round-results', d => {
        stopTimer();
        processRound(d);
    });

    G.socket.on('game-finished', d => {
        stopTimer();
        document.getElementById('round-overlay').classList.remove('on');
        clearInterval(G.ovTimer);
        showFinal(d);
    });

    G.socket.on('error', d => {
        toast(d.message || 'Error del servidor', 'e');
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openLobby() {
    show('lobby');
    document.getElementById('lobby-code').textContent = G.roomCode;
    document.getElementById('room-pill').textContent  = G.roomCode;
    renderLobbyPlayers();

    const startBtn = document.getElementById('btn-start');
    const msg      = document.getElementById('lobby-msg');
    if (G.isHost) {
        startBtn.style.display = 'block';
        msg.textContent = 'ESPERANDO JUGADORESâ€¦';
    } else {
        startBtn.style.display = 'none';
        msg.textContent = 'ESPERANDO AL HOSTâ€¦';
    }
}

function renderLobbyPlayers() {
    const grid  = document.getElementById('lobby-grid');
    const count = G.pCount || G.players.length;
    grid.innerHTML = '';

    G.players.forEach(p => {
        const slot = document.createElement('div');
        slot.className = 'p-slot' + (p.isHost ? ' host-slot' : '');
        slot.innerHTML = `
            <div class="slot-avatar">${p.avatar || 'âš¡'}</div>
            <div class="slot-name">${esc(p.name)}</div>
            ${p.isHost ? '<div class="slot-badge">â˜… HOST</div>' : ''}
        `;
        grid.appendChild(slot);
    });

    document.getElementById('lobby-count').textContent = `${count} / 30`;

    if (G.isHost) {
        const btn = document.getElementById('btn-start');
        const msg = document.getElementById('lobby-msg');
        if (count >= 2) {
            btn.disabled = false;
            msg.textContent = 'Â¡LISTOS PARA COMENZAR!';
            msg.style.color = 'var(--cyan)';
        } else {
            btn.disabled = true;
            msg.textContent = 'ESPERANDO MÃS JUGADORESâ€¦';
            msg.style.color = '';
        }
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDERIZAR PREGUNTA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderQuestion(data) {
    const { question, questionNumber, timeLimit } = data;

    document.getElementById('q-num').textContent  = questionNumber;

    // Pregunta con re-animaciÃ³n
    const qtEl = document.getElementById('q-text');
    qtEl.style.animation = 'none'; void qtEl.offsetWidth;
    qtEl.style.animation = '';
    qtEl.textContent = question.question;

    // Resetear tarjeta
    document.getElementById('q-card').className = 'q-card';

    // Opciones de respuesta
    const grid = document.getElementById('ans-grid');
    grid.innerHTML = '';

    if (question.options?.length) {
        grid.style.gridTemplateColumns = question.options.length <= 2 ? '1fr' : 'repeat(2,1fr)';
        question.options.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className    = 'ans-btn';
            btn.dataset.answer = opt;
            btn.innerHTML    = `<span class="ans-ltr">${LTRS[i] || ''}</span>${esc(opt)}`;
            btn.addEventListener('click', () => submitAnswer(opt, btn));
            grid.appendChild(btn);
        });
    }

    const sl = document.getElementById('status-line');
    sl.textContent = 'Selecciona una respuesta Â· usa teclas A B C D';
    sl.className   = 'status-line';

    renderLiveScoreboard();

    const secs = timeLimit || 15;
    G.tMax = secs;
    startTimer(secs);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEMPORIZADOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startTimer(secs) {
    stopTimer();
    G.tLeft = secs;
    const ring = document.getElementById('t-ring');
    const num  = document.getElementById('t-num');
    ring.setAttribute('class', 't-ring');
    num.style.color = 'var(--text-bright)';

    let last    = performance.now();
    let ticked  = false;

    function tick(now) {
        const dt = (now - last) / 1000;
        last = now;
        G.tLeft = Math.max(0, G.tLeft - dt);

        const ratio  = G.tLeft / secs;
        const offset = CIRC * (1 - ratio);
        ring.style.strokeDashoffset = offset;
        num.textContent = Math.ceil(G.tLeft);

        if (ratio <= 0.25) {
            ring.setAttribute('class', 't-ring crit'); num.style.color = 'var(--pink)';
            if (!ticked && G.tLeft < 5) {
                sfx.tick(); ticked = true;
                setTimeout(() => { ticked = false; }, 950);
            }
        } else if (ratio <= 0.5) {
            ring.setAttribute('class', 't-ring warn'); num.style.color = 'var(--yellow)';
        } else {
            ring.setAttribute('class', 't-ring'); num.style.color = 'var(--text-bright)';
        }

        if (G.tLeft <= 0) {
            stopTimer();
            if (!G.hasAnswered) {
                G.hasAnswered = true;
                G.socket.emit('submit-answer', { roomCode:G.roomCode, answer:'', timeRemaining:0 });
                const sl = document.getElementById('status-line');
                sl.textContent = 'â° TIEMPO AGOTADO';
                sl.className   = 'status-line';
                sfx.wrong();
                flashCard('bad');
            }
            return;
        }
        G.raf = requestAnimationFrame(tick);
    }
    G.raf = requestAnimationFrame(tick);
}

function stopTimer() {
    if (G.raf) { cancelAnimationFrame(G.raf); G.raf = null; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENVIAR RESPUESTA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function submitAnswer(answer, btn) {
    if (G.hasAnswered) return;
    G.hasAnswered = true;
    sfx.click();
    stopTimer();

    document.querySelectorAll('.ans-btn').forEach(b => b.disabled = true);
    btn.classList.add('selected');

    G.socket.emit('submit-answer', {
        roomCode     : G.roomCode,
        answer       : answer,
        timeRemaining: Math.ceil(G.tLeft)
    });

    const sl = document.getElementById('status-line');
    sl.textContent = 'âœ“ RESPUESTA ENVIADA â€” esperando resultadoâ€¦';
    sl.className   = 'status-line answered';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROCESAR RESULTADOS DE RONDA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function processRound(data) {
    const myResult  = data.roundRanking?.find(r => r.playerId === G.socket.id);
    const isCorrect = myResult?.isCorrect || false;
    const pts       = myResult?.pointsEarned || 0;

    // Marcar botones: correcto / incorrecto
    document.querySelectorAll('.ans-btn').forEach(btn => {
        if (String(btn.dataset.answer) === String(data.correctAnswer)) {
            btn.classList.remove('selected');
            btn.classList.add('correct');
        }
    });
    document.querySelectorAll('.ans-btn.selected').forEach(btn => {
        btn.classList.remove('selected');
        btn.classList.add('wrong');
    });

    flashCard(isCorrect ? 'ok' : 'bad');
    if (isCorrect) sfx.correct(); else sfx.wrong();

    // Actualizar vidas basado en quienes erraron en esta ronda
    let lostLife = false;
    if (data.roundRanking) {
        data.roundRanking.forEach(r => {
            if (!r.isCorrect) {
                const player = G.players.find(p => p.id === r.playerId);
                if (player) G.lives[player.name] = Math.max(0, (G.lives[player.name] ?? 3) - 1);
                if (r.playerId === G.socket.id) { G.myLives = Math.max(0, G.myLives - 1); lostLife = true; }
            }
        });
    }

    updateMyLives(lostLife ? 'break' : null);
    renderLiveScoreboard(data.overallRanking);
    showRoundOverlay(isCorrect, pts, data.correctAnswer, lostLife);
}

function showRoundOverlay(isCorrect, pts, correctAnswer, lostLife) {
    document.getElementById('ov-verdict').textContent  = isCorrect ? 'Â¡CORRECTO!' : 'âœ— INCORRECTO';
    document.getElementById('ov-verdict').className    = `verdict ${isCorrect ? 'ok' : 'bad'}`;
    document.getElementById('ov-pts').textContent      = isCorrect ? `+${pts} PTS` : '+0 PTS';
    document.getElementById('ov-pts').style.color      = isCorrect ? 'var(--yellow)' : 'var(--text-dim)';
    document.getElementById('ov-pts').style.textShadow = isCorrect ? 'var(--glow-y)' : 'none';
    document.getElementById('ov-ans-val').textContent  = correctAnswer || 'â€”';
    document.getElementById('ov-life').style.display   = lostLife ? 'block' : 'none';

    if (lostLife) sfx.lifeLost();

    const ov  = document.getElementById('round-overlay');
    const nEl = document.getElementById('ov-n');
    ov.classList.add('on');

    let cd = 5; nEl.textContent = cd;
    clearInterval(G.ovTimer);
    G.ovTimer = setInterval(() => {
        cd--; nEl.textContent = Math.max(0, cd);
        if (cd <= 0) { clearInterval(G.ovTimer); ov.classList.remove('on'); }
    }, 1000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCOREBOARD EN VIVO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderLiveScoreboard(rankings = null) {
    const board = document.getElementById('live-lb');
    board.innerHTML = '';

    const rows = rankings
        ? rankings.map(r => ({
            name : r.playerName,
            score: r.totalScore,
            rank : r.rank,
            lives: G.lives[r.playerName] ?? 3,
            isMe : r.playerName === G.myName,
        }))
        : G.players.map((p, i) => ({
            name : p.name,
            score: 0,
            rank : i + 1,
            lives: G.lives[p.name] ?? 3,
            isMe : p.name === G.myName,
        }));

    rows.forEach((row, i) => {
        const rkC = ['r1','r2','r3'][i] || '';
        const hrt = 'â¤ï¸'.repeat(Math.max(0, row.lives)) + 'ğŸ–¤'.repeat(Math.max(0, 3 - row.lives));
        const div = document.createElement('div');
        div.className = `lb-row${row.isMe ? ' me' : ''}${row.lives <= 0 ? ' eliminated' : ''}`;
        div.innerHTML = `
            <div class="lb-rank ${rkC}">${row.rank || i+1}</div>
            <div class="lb-av">${getAvatar(row.name)}</div>
            <div class="lb-info">
                <div class="lb-name">${esc(row.name)}${row.isMe ? '<span style="font-size:.52rem;color:var(--cyan);margin-left:.3rem;">TÃš</span>' : ''}</div>
                <div class="lb-pts">${row.score} pts</div>
            </div>
            <div class="lb-lives">${hrt}</div>
        `;
        board.appendChild(div);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MIS VIDAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateMyLives(effect = null) {
    const hearts = document.querySelectorAll('#my-lives .heart');
    hearts.forEach((h, i) => {
        if (i < G.myLives) {
            h.className = 'heart'; h.textContent = 'â¤ï¸';
        } else {
            if (i === G.myLives && effect === 'break') {
                h.classList.add('breaking');
                setTimeout(() => {
                    h.classList.remove('breaking');
                    h.className   = 'heart dead';
                    h.textContent = 'ğŸ–¤';
                }, 560);
            } else {
                h.className = 'heart dead'; h.textContent = 'ğŸ–¤';
            }
        }
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANTALLA FINAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showFinal(data) {
    const rankings = data.finalRanking || [];
    sfx.fanfare();
    show('final');

    // Podio
    const podium = document.getElementById('podium');
    podium.innerHTML = '';
    const order  = [1, 0, 2];
    const blocks = [
        { cls:'p2', h:'68px',  lbl:'2' },
        { cls:'p1', h:'100px', lbl:'ğŸ†' },
        { cls:'p3', h:'48px',  lbl:'3' },
    ];
    order.forEach((idx, vi) => {
        const player = rankings[idx];
        if (!player) return;
        const b     = blocks[vi];
        const lives = G.lives[player.playerName] ?? 0;
        const hrt   = lives > 0 ? 'â¤ï¸'.repeat(lives) : 'ğŸ’€';
        const pod   = document.createElement('div');
        pod.className = 'pod';
        pod.innerHTML = `
            <div class="pod-av">${getAvatar(player.playerName)}</div>
            <div class="pod-name">${esc(player.playerName)}</div>
            <div class="pod-score">${player.totalScore} pts Â· ${hrt}</div>
            <div class="pod-block ${b.cls}" style="height:${b.h}"><div class="pod-num">${b.lbl}</div></div>
        `;
        podium.appendChild(pod);
    });

    // Lista completa
    const list = document.getElementById('final-list');
    list.innerHTML = '';
    const rkColors = ['#ffd700','#c0c0c0','#cd7f32'];
    rankings.forEach((p, i) => {
        const lives = G.lives[p.playerName] ?? 0;
        const hrt   = 'â¤ï¸'.repeat(Math.max(0, lives)) + 'ğŸ–¤'.repeat(Math.max(0, 3 - lives));
        const row   = document.createElement('div');
        row.className = 'rank-row';
        row.innerHTML = `
            <div class="rk-n" style="color:${rkColors[i]||'var(--text-dim)'};">${p.rank}</div>
            <div class="rk-av">${getAvatar(p.playerName)}</div>
            <div class="rk-nm">${esc(p.playerName)}</div>
            <div class="rk-pt">${p.totalScore} pts</div>
            <div class="rk-lv">${hrt}</div>
        `;
        list.appendChild(row);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACCIONES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function doCreate() {
    const name = document.getElementById('inp-name').value.trim();
    if (!name) { toast('Ingresa tu nombre de combate','e'); return; }
    G.myName     = name;
    G.difficulty = document.querySelector('.diff-btn.active').dataset.diff;
    sfx.click();
    const s = DIFF_SETTINGS[G.difficulty];
    G.socket.emit('create-room', {
        playerName  : name,
        gameSettings: {
            maxPlayers    : 30,
            totalQuestions: s.totalQuestions,
            questionTime  : s.questionTime,
            difficultyLevel: s.difficultyLevel,
            categories    : ['arithmetic'],
        }
    });
}

function doJoinScreen() {
    const name = document.getElementById('inp-name').value.trim();
    if (!name) { toast('Ingresa tu nombre de combate','e'); return; }
    G.myName = name;
    sfx.click();
    show('join');
}

function doJoin() {
    const code = document.getElementById('inp-code').value.trim().toUpperCase();
    if (code.length !== 6) { toast('El cÃ³digo debe tener 6 caracteres','e'); return; }
    sfx.click();
    G.socket.emit('join-room', { playerName:G.myName, roomCode:code });
}

function doStart() {
    if (!G.isHost) return;
    if ((G.pCount || G.players.length) < 2) { toast('Necesitas al menos 2 jugadores','e'); return; }
    sfx.click();

    // Deshabilitar botÃ³n para evitar mÃºltiples inicios
    const btn = document.getElementById('btn-start');
    const msg = document.getElementById('lobby-msg');
    btn.disabled = true;
    btn.textContent = 'â³ INICIANDOâ€¦';
    msg.textContent = 'Â¡EL JUEGO COMIENZA EN 3 SEGUNDOS!';
    msg.style.color = 'var(--yellow)';

    G.socket.emit('start-game', { roomCode:G.roomCode });
}

function doLeave() {
    sfx.click();
    G.socket.disconnect();
    G.socket.connect();
    resetState();
    show('welcome');
}

function resetState() {
    stopTimer();
    clearInterval(G.ovTimer);
    Object.assign(G, {
        myName:'', roomCode:'', isHost:false, difficulty:'easy',
        players:[], pCount:0, lives:{},
        myLives:3, score:0, qNum:0, hasAnswered:false,
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TECLADO: A B C D / 1 2 3 4
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', e => {
    if (!SCR.game.classList.contains('on') || G.hasAnswered) return;
    const map = { 'a':'0','1':'0', 'b':'1','2':'1', 'c':'2','3':'2', 'd':'3','4':'3' };
    const idx = map[e.key.toLowerCase()];
    if (idx !== undefined) {
        const btns = document.querySelectorAll('#ans-grid .ans-btn:not(:disabled)');
        if (btns[idx]) btns[idx].click();
    }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function flashCard(type) {
    const card = document.getElementById('q-card');
    card.className = 'q-card'; void card.offsetWidth;
    if (type === 'ok')  card.classList.add('flash-ok');
    if (type === 'bad') { card.classList.add('flash-bad'); card.classList.add('shake'); }
    setTimeout(() => { card.className = 'q-card'; }, 700);
}

function getAvatar(name) {
    const player = G.players.find(p => p.name === name);
    return player?.avatar || 'âš¡';
}

function esc(str) {
    const d = document.createElement('div');
    d.textContent = String(str);
    return d.innerHTML;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BIND EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bindEvents() {
    // Dificultad
    document.querySelectorAll('.diff-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            sfx.click();
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });

    // Bienvenida
    document.getElementById('btn-create').addEventListener('click', doCreate);
    document.getElementById('btn-join-go').addEventListener('click', doJoinScreen);
    document.getElementById('inp-name').addEventListener('keypress', e => { if (e.key==='Enter') doCreate(); });

    // Unirse
    document.getElementById('btn-back').addEventListener('click', () => { sfx.click(); show('welcome'); });
    document.getElementById('btn-join').addEventListener('click', doJoin);
    document.getElementById('inp-code').addEventListener('keypress', e => { if (e.key==='Enter') doJoin(); });
    document.getElementById('inp-code').addEventListener('input',   e => { e.target.value = e.target.value.toUpperCase(); });

    // Lobby
    document.getElementById('btn-start').addEventListener('click', doStart);
    document.getElementById('btn-leave').addEventListener('click', doLeave);

    // Copiar cÃ³digo al hacer clic
    document.getElementById('lobby-code').addEventListener('click', () => {
        const code = G.roomCode;
        if (!code || code === '------') return;
        navigator.clipboard?.writeText(code).then(() => {
            document.getElementById('lobby-copy-hint').textContent = 'âœ“ Â¡CÃ³digo copiado!';
            setTimeout(() => { document.getElementById('lobby-copy-hint').textContent = 'ğŸ“‹ Clic para copiar'; }, 2000);
        }).catch(() => toast('Copia el cÃ³digo: ' + code, 'i', 5000));
    });

    // Final
    document.getElementById('btn-again').addEventListener('click', () => { sfx.click(); resetState(); show('welcome'); });
    document.getElementById('btn-menu').addEventListener('click',  () => { sfx.click(); resetState(); show('welcome'); });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', () => {
    initParticles();
    bindEvents();
    connect();
});

})();
</script>
</body>
</html>
